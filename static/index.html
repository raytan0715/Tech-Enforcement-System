<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交通違規上傳</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>

    <div class="container">
        <div class="left-column">
            <h2>上傳違規圖片</h2>
            <form id="violationForm">
                <label for="cam_id">相機 ID</label>
                <input type="text" id="cam_id" name="cam_id" placeholder="輸入相機 ID" required>

                <label for="speed_limit">速限 (公里/小時)</label>
                <input type="number" id="speed_limit" name="speed_limit" placeholder="輸入速限" required>

                <label for="current_speed">當前車速 (公里/小時)</label>
                <input type="number" id="current_speed" name="current_speed" placeholder="輸入當前車速" required>

                <label for="location">違規地點</label>
                <input type="text" id="location" name="location" placeholder="輸入違規地點" required>

                <label for="date_time">時間</label>
                <input type="datetime-local" id="date_time" name="date_time" required>

                <label for="image">選擇圖片</label>
                <input type="file" id="image" name="image" accept="image/*" required>

                <!-- 圖片預覽 -->
                <img id="imagePreview" src="" alt="圖片預覽" style="display: none;">

                <button type="submit">提交</button>
            </form>

            <div class="message" id="message"></div>
        </div>

        <div class="right-column">
            <h2>辨識紀錄</h2>
            <div class="history" id="history"></div>
        </div>
    </div>

    <script>
        // 當用戶選擇圖片時，顯示圖片預覽
        document.getElementById("image").addEventListener("change", function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const imagePreview = document.getElementById("imagePreview");
                imagePreview.src = e.target.result;
                imagePreview.style.display = "block";
            }

            if (file) {
                reader.readAsDataURL(file);
            }
        });

        // 表單提交邏輯
        document.getElementById("violationForm").addEventListener("submit", function (event) {
            event.preventDefault();

            // 取得表單資料
            let formData = new FormData();
            formData.append("image", document.getElementById("image").files[0]);
            formData.append("cam_id", document.getElementById("cam_id").value);
            formData.append("speed_limit", document.getElementById("speed_limit").value);
            formData.append("current_speed", document.getElementById("current_speed").value);
            formData.append("location", document.getElementById("location").value);
            formData.append("date_time", document.getElementById("date_time").value);

            // 發送 POST 請求
            fetch("http://127.0.0.1:5000/api/upload_image", {
                method: "POST",
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById("message");
                    const historyDiv = document.getElementById("history");

                    if (data.license_plate) {
                        // 顯示成功訊息
                        messageDiv.innerHTML = `車牌: ${data.license_plate}<br>違規處理成功！`;
                        messageDiv.style.color = "green";

                        // 新增到辨識紀錄
                        const record = document.createElement("div");
                        record.classList.add("history-item");
                        record.innerHTML = `
                            <strong>相機 ID：</strong>${formData.get("cam_id")}<br>
                            <strong>車牌：</strong>${data.license_plate}<br>
                            <strong>速限：</strong>${formData.get("speed_limit")} km/h<br>
                            <strong>當前車速：</strong>${formData.get("current_speed")} km/h<br>
                            <strong>地點：</strong>${formData.get("location")}<br>
                            <strong>時間：</strong>${formData.get("date_time")}
                        `;
                        historyDiv.insertBefore(record, historyDiv.firstChild);

                        // 清空表單欄位
                        document.getElementById("violationForm").reset();
                        document.getElementById("imagePreview").style.display = "none";
                    } else {
                        // 顯示錯誤訊息
                        messageDiv.innerHTML = `錯誤: ${data.error}`;
                        messageDiv.style.color = "red";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById("message").innerText = "發生錯誤，請稍後再試。";
                    document.getElementById("message").style.color = "red";
                });
        });
    </script>
</body>

</html>
